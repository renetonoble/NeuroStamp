<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroStamp | Robust Watermarking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-custom { background-color: #4a148c; color: white; }
        .btn-custom:hover { background-color: #6a1b9a; color: white; }
        .result-box { background-color: #e9ecef; border-radius: 10px; padding: 15px; display: none; }
        .spinner-border { width: 1.5rem; height: 1.5rem; }
    </style>
</head>
<body>

    <div class="container py-5 text-center">
        <h1 class="display-4 fw-bold text-primary">üß† NeuroStamp</h1>
        <p class="lead text-muted">Invisible DWT Watermarking & Ownership Verification System</p>
        
        <a href="/db-viewer" class="btn btn-outline-dark btn-sm mt-2 shadow-sm">
            üìÇ Open Database Monitor
        </a>
    </div>

    <div class="container">
        <div class="row g-4">
            
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center p-4">
                        <h3 class="card-title mb-3">1. Register</h3>
                        <p class="text-muted small">Create your digital identity.</p>
                        <form id="registerForm" onsubmit="handleRegister(event)">
                            <input type="text" class="form-control mb-3" name="username" placeholder="Enter Username" required>
                            <button type="submit" class="btn btn-custom w-100">Create Secure ID</button>
                        </form>
                        <div id="registerResult" class="mt-3 text-success fw-bold small"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center p-4">
                        <h3 class="card-title mb-3">2. Stamp & Attack</h3>
                        <p class="text-muted small">Embed ID or Test Robustness.</p>
                        
                        <form id="stampForm" onsubmit="handleStamp(event)">
                            <input type="text" class="form-control mb-2" id="stampUser" placeholder="Username" required>
                            <input type="file" class="form-control mb-3" id="stampFile" required>
                            <button type="submit" class="btn btn-custom w-100">Stamp & Download</button>
                        </form>

                        <div id="stampResult" class="mt-3"></div>

                        <hr class="my-4">
                        <h6 class="text-danger fw-bold">‚öîÔ∏è Simulation Lab</h6>
                        <p class="small text-muted mb-2">Test robustness against attacks:</p>
                        
                        <div class="btn-group w-100 mb-2" role="group">
                            <button onclick="attack('noise')" class="btn btn-outline-danger btn-sm">Noise</button>
                            <button onclick="attack('blur')" class="btn btn-outline-warning btn-sm">Blur</button>
                            <button onclick="attack('jpeg')" class="btn btn-outline-secondary btn-sm">JPEG</button>
                        </div>
                        <div class="btn-group w-100" role="group">
                            <button onclick="attack('rotate')" class="btn btn-outline-dark btn-sm">Rotate 5¬∞</button>
                            <button onclick="attack('crop')" class="btn btn-outline-dark btn-sm">Crop 20%</button>
                        </div>
                        <div id="attackResult" class="mt-2 small fw-bold"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center p-4">
                        <h3 class="card-title mb-3">3. Verify Owner</h3>
                        <p class="text-muted small">Check suspicious images.</p>
                        
                        <form id="verifyForm" onsubmit="handleVerify(event)">
                            <input type="text" class="form-control mb-2" id="verifyUser" placeholder="Claimed Username" required>
                            <input type="file" class="form-control mb-3" id="verifyFile" required>
                            <button type="submit" class="btn btn-secondary w-100">Analyze Image</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-4">
            <div id="verifyResult" class="result-box text-center shadow-sm">
                </div>
        </div>
    </div>

    <script>
        let currentStampedFilename = ""; // Stores the filename of the last stamped image for attacks

        async function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const res = await fetch('/register', { method: 'POST', body: formData });
            const data = await res.json();
            document.getElementById('registerResult').innerText = data.message;
        }

        async function handleStamp(e) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('username', document.getElementById('stampUser').value);
            formData.append('file', document.getElementById('stampFile').files[0]);

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                const res = await fetch('/stamp', { method: 'POST', body: formData });
                const data = await res.json();
                
                if(data.status === 'success') {
                    // Save filename for attacks
                    currentStampedFilename = data.download_url.split('/').pop();
                    
                    document.getElementById('stampResult').innerHTML = `
                        <a href="${data.download_url}" class="btn btn-success w-100 mb-2" download>
                            Download Protected Image ‚¨áÔ∏è
                        </a>
                        <p class="text-success small">‚úÖ Watermark Embedded!</p>
                    `;
                    document.getElementById('attackResult').innerHTML = ""; // Clear old attacks
                } else {
                    document.getElementById('stampResult').innerHTML = `<p class="text-danger fw-bold">${data.error}</p>`;
                }
            } catch (err) {
                alert("Error connecting to server");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function handleVerify(e) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('username', document.getElementById('verifyUser').value);
            formData.append('file', document.getElementById('verifyFile').files[0]);

            const resBox = document.getElementById('verifyResult');
            resBox.style.display = 'block';
            resBox.innerHTML = `<h4>üîç Analyzing DWT Frequency Bands...</h4><div class="spinner-border text-primary" role="status"></div>`;

            const res = await fetch('/verify', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.error) {
                resBox.innerHTML = `<h4 class="text-danger">‚ö†Ô∏è ${data.error}</h4>`;
            } else if (data.is_match) {
                resBox.innerHTML = `
                    <h2 class="text-success fw-bold">‚úÖ CONFIRMED</h2>
                    <p class="lead">This image belongs to <span class="fw-bold">${data.owner}</span></p>
                    <div class="alert alert-light border">
                        <small>Extracted ID: ${data.extracted_text}</small>
                    </div>
                `;
            } else {
                resBox.innerHTML = `
                    <h2 class="text-danger fw-bold">‚ùå MISMATCH / FAKE</h2>
                    <p>The watermark signature does not match this user.</p>
                    <div class="alert alert-light border">
                        <small>Extracted Data: ${data.extracted_text || "Noise/Corrupted"}</small>
                    </div>
                `;
            }
        }

        async function attack(type) {
            if (!currentStampedFilename) {
                alert("Please stamp an image first!");
                return;
            }

            const formData = new FormData();
            formData.append('filename', currentStampedFilename);
            formData.append('attack_type', type);

            document.getElementById('attackResult').innerHTML = `<span class="text-warning">Applying ${type}...</span>`;

            const res = await fetch('/attack', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.status === 'success') {
                document.getElementById('attackResult').innerHTML = `
                    <a href="${data.attack_url}" target="_blank" class="text-danger fw-bold">Download ${type} Image</a>
                `;
            }
        }
    </script>
</body>
</html>